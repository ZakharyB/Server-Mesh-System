<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mesh Controller (Port 5000)</title>

</head>
<style>
    body {
background-color: #0d1117;
color: #c9d1d9;
font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
padding: 20px;
margin: 0;
}
h1 { border-bottom: 1px solid #30363d; padding-bottom: 15px; }
.grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
gap: 20px;
margin-top: 20px;
}
.card {
background-color: #161b22;
border: 1px solid #30363d;
border-radius: 6px;
padding: 20px;
position: relative;
}
.card.online { border-left: 5px solid #2ea043; }
.card.offline { border-left: 5px solid #da3633; opacity: 0.8; }

.status-badge {
position: absolute;
top: 20px;
right: 20px;
padding: 4px 8px;
border-radius: 4px;
font-size: 12px;
font-weight: bold;
}
.online .status-badge { background: #2ea043; color: white; }
.offline .status-badge { background: #da3633; color: white; }

.stat-row {
display: flex;
justify-content: space-between;
margin-top: 10px;
font-size: 14px;
}
.ping { color: #f2cc60; }
.bar-bg {
background: #30363d;
height: 8px;
border-radius: 4px;
margin-top: 15px;
overflow: hidden;
}
.bar-fill { height: 100%; transition: width 0.5s; }
</style>
<body>

    <h1>Mesh Network Status (Port 5000)</h1>
    <div id="loading">Connecting to Master Controller...</div>
    <div id="grid" class="grid"></div>

    <script>
        async function fetchStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                render(data);
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error("Error fetching stats:", error);
                document.getElementById('loading').innerText = "Error: Could not reach Python Controller on Port 5000.";
            }
        }

        function render(nodes) {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';

            Object.keys(nodes).forEach(name => {
                const node = nodes[name];
                const isOnline = node.alive;
                const percent = isOnline ? (node.users / node.max) * 100 : 0;
                
                let color = '#58a6ff';
                if(percent > 50) color = '#d29922';
                if(percent > 85) color = '#da3633';

                const html = `
                    <div class="card ${isOnline ? 'online' : 'offline'}">
                        <span class="status-badge">${isOnline ? 'ONLINE' : 'OFFLINE'}</span>
                        <h2 style="margin:0 0 10px 0; font-size:1.2em">${name}</h2>
                        
                        <div class="stat-row">
                            <span>IP Address</span>
                            <code>${node.ip}</code>
                        </div>

                        ${isOnline ? `
                            <div class="stat-row">
                                <span>Latency</span>
                                <span class="ping">${node.ping} ms</span>
                            </div>
                            <div class="stat-row">
                                <span>CPU Load</span>
                                <span>${node.load}%</span>
                            </div>
                            <div class="stat-row">
                                <span>Users</span>
                                <span>${node.users} / ${node.max}</span>
                            </div>
                            <div class="bar-bg">
                                <div class="bar-fill" style="width: ${percent}%; background-color: ${color}"></div>
                            </div>
                        ` : `
                            <div style="margin-top:20px; color:#8b949e">
                                Node unreachable. <br>Last Error: ${node.error || 'Timeout'}
                            </div>
                        `}
                    </div>
                `;
                grid.innerHTML += html;
            });
        }

        setInterval(fetchStats, 2000);
        fetchStats();
    </script>
</body>
</html>