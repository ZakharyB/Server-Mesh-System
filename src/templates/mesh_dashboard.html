<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mesh Controller (Port 5000)</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <h1>Mesh Network Status (Port 5000)</h1>
    <div id="loading">Connecting to Master Controller...</div>
    <div id="grid" class="grid"></div>

    <script>
        async function fetchStats() {
            try {
                // Fetch directly from the API on this same port (5000)
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                render(data);
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error("Error fetching stats:", error);
                document.getElementById('loading').innerText = "Error: Could not reach Python Controller on Port 5000.";
            }
        }

        function render(nodes) {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';

            // Convert object to array for easier looping
            Object.keys(nodes).forEach(name => {
                const node = nodes[name];
                const isOnline = node.alive;
                const percent = isOnline ? (node.users / node.max) * 100 : 0;
                
                // Color logic for load bar
                let color = '#58a6ff';
                if(percent > 50) color = '#d29922';
                if(percent > 85) color = '#da3633';

                const html = `
                    <div class="card ${isOnline ? 'online' : 'offline'}">
                        <span class="status-badge">${isOnline ? 'ONLINE' : 'OFFLINE'}</span>
                        <h2 style="margin:0 0 10px 0; font-size:1.2em">${name}</h2>
                        
                        <div class="stat-row">
                            <span>IP Address</span>
                            <code>${node.ip}</code>
                        </div>

                        ${isOnline ? `
                            <div class="stat-row">
                                <span>Latency</span>
                                <span class="ping">${node.ping} ms</span>
                            </div>
                            <div class="stat-row">
                                <span>CPU Load</span>
                                <span>${node.load}%</span>
                            </div>
                            <div class="stat-row">
                                <span>Users</span>
                                <span>${node.users} / ${node.max}</span>
                            </div>
                            <div class="bar-bg">
                                <div class="bar-fill" style="width: ${percent}%; background-color: ${color}"></div>
                            </div>
                        ` : `
                            <div style="margin-top:20px; color:#8b949e">
                                Node unreachable. <br>Last Error: ${node.error || 'Timeout'}
                            </div>
                        `}
                    </div>
                `;
                grid.innerHTML += html;
            });
        }

        // Auto-refresh every 2 seconds
        setInterval(fetchStats, 2000);
        fetchStats();
    </script>
</body>
</html>